<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Startup Timing Instrumentation</title>
  <style>
    /* Default styles provided by pandoc.
    ** See https://pandoc.org/MANUAL.html#variables-for-html for config info.
    */
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    svg {
      height: auto;
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      border: none;
      border-top: 1px solid #1a1a1a;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
<style>

:root {
    --bg: #ffffff;
    --bg-subtle: #f8f9fa;
    --bg-code: #f4f4f4;
    --text: #212529;
    --text-muted: #6c757d;
    --accent: #0d6efd;
    --accent-hover: #0a58ca;
    --border: #dee2e6;
    --link-visited: #6610f2;
    --success: #198754;
}

* {
    box-sizing: border-box;
}

html {
    font-size: 16px;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    line-height: 1.6;
    max-width: 50rem;
    margin: 0 auto;
    padding: 2rem 1.5rem;
    background: var(--bg);
    color: var(--text);
}

h1, h2, h3, h4, h5, h6 {
    font-weight: 500;
    line-height: 1.2;
    margin-top: 1.5em;
    margin-bottom: 0.5em;
    color: var(--text);
}

h1 {
    font-size: 2.25rem;
    font-weight: 300;
    border-bottom: 1px solid var(--border);
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
}

h2 {
    font-size: 1.75rem;
    font-weight: 400;
}

h3 {
    font-size: 1.375rem;
}

h4 { font-size: 1.125rem; }

a {
    color: var(--accent);
    text-decoration: none;
}

a:hover {
    color: var(--accent-hover);
    text-decoration: underline;
}

a:visited {
    color: var(--link-visited);
}

p {
    margin-bottom: 1rem;
}

code {
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    font-size: 0.875em;
    background: var(--bg-code);
    color: #d63384;
    padding: 0.2em 0.4em;
    border-radius: 4px;
}

pre {
    background: var(--bg-code);
    padding: 1rem;
    overflow-x: auto;
    border-radius: 6px;
    border: 1px solid var(--border);
    margin: 1rem 0;
}

pre code {
    padding: 0;
    background: none;
    color: var(--text);
    font-size: 0.875rem;
}

blockquote {
    border-left: 4px solid var(--accent);
    margin: 1rem 0;
    padding: 0.5rem 1rem;
    background: var(--bg-subtle);
    color: var(--text-muted);
}

blockquote p {
    margin: 0;
}

ul, ol {
    margin-bottom: 1rem;
    padding-left: 2rem;
}

li {
    margin-bottom: 0.25rem;
}

table {
    border-collapse: collapse;
    width: 100%;
    margin: 1rem 0;
}

th, td {
    border: 1px solid var(--border);
    padding: 0.75rem;
    text-align: left;
}

th {
    background: var(--bg-subtle);
    font-weight: 600;
}

tr:nth-child(even) {
    background: var(--bg-subtle);
}

hr {
    border: none;
    border-top: 1px solid var(--border);
    margin: 2rem 0;
}

img {
    max-width: 100%;
    height: auto;
    border-radius: 4px;
}

/* Navigation */
.docweave-nav {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border);
}

.back-to-root {
    display: inline-block;
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--accent);
    background: var(--bg-subtle);
    border: 1px solid var(--border);
    border-radius: 4px;
    transition: all 0.15s ease-in-out;
}

.back-to-root:hover {
    background: var(--accent);
    color: white;
    text-decoration: none;
    border-color: var(--accent);
}

/* Footer */
.docweave-footer {
    margin-top: 3rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border);
    font-size: 0.875rem;
    color: var(--text-muted);
}

.backlinks {
    margin-bottom: 0.75rem;
    padding: 0.75rem 1rem;
    background: var(--bg-subtle);
    border-radius: 4px;
}

.backlinks strong {
    color: var(--text);
}

.backlinks a {
    color: var(--accent);
}

.docweave-credit {
    font-size: 0.75rem;
    opacity: 0.6;
}

/* Responsive */
@media (max-width: 600px) {
    body {
        padding: 1rem;
    }
    
    h1 { font-size: 1.75rem; }
    h2 { font-size: 1.5rem; }
    
    table {
        font-size: 0.875rem;
    }
    
    th, td {
        padding: 0.5rem;
    }
}

</style>
</head>
<body>
<nav class="docweave-nav">
<a href="index.html" class="back-to-root">Back to CoilViewer</a>
</nav>
<header id="title-block-header">
<h1 class="title">Startup Timing Instrumentation</h1>
</header>
<h1 id="startup-timing-instrumentation">Startup Timing Instrumentation</h1>
<h2 id="overview">Overview</h2>
<p>I've added comprehensive timing measurements to <strong>every step</strong> of the CoilViewer startup process, from when you click to open the program until the first image is displayed on screen.</p>
<h2 id="how-to-view-timing-data">How to View Timing Data</h2>
<p>All timing information is logged to <code>coilviewer-launch.log</code> in the project root directory. Each timing entry is tagged with a category prefix:</p>
<ul>
<li><code>[STARTUP]</code> - Application initialization (App.xaml.cs)</li>
<li><code>[MAINWINDOW]</code> - MainWindow constructor and initialization</li>
<li><code>[LOADSEQUENCE]</code> - Image sequence loading</li>
<li><code>[IMAGESEQUENCE]</code> - Directory enumeration and sorting</li>
<li><code>[DISPLAYCURRENT]</code> - Image display process</li>
<li><code>[IMAGECACHE]</code> - Image file loading and decoding</li>
</ul>
<h2 id="what-gets-measured">What Gets Measured</h2>
<h3 id="1-application-startup-apponstartup">1. Application Startup (<code>App.OnStartup</code>)</h3>
<ul>
<li><code>base.OnStartup</code> - WPF framework initialization</li>
<li><code>Logger.LogLaunch</code> - Logging initialization</li>
<li><code>Config loading</code> - Reading and parsing config.json</li>
<li><code>InitializeModelsAsync</code> - Starting async ML model loading (non-blocking)</li>
<li><code>Path resolution</code> - Resolving command-line arguments</li>
<li><code>DirectoryInstanceGuard setup</code> - Multi-instance coordination</li>
<li><code>MainWindow constructor</code> - Creating main window</li>
<li><code>window.Show()</code> - Displaying the window</li>
<li><code>Window activation and focus</code> - Bringing window to front</li>
<li><strong>TOTAL APP STARTUP TIME</strong> - Overall startup time</li>
</ul>
<h3 id="2-mainwindow-initialization">2. MainWindow Initialization</h3>
<ul>
<li><code>InitializeComponent</code> - XAML parsing and control creation</li>
<li><code>Field initialization</code> - Setting up internal fields</li>
<li><code>ApplyConfig</code> - Applying user configuration</li>
<li><code>UpdateContextMenu</code> - Building context menu</li>
<li><code>InitializeFilterControls</code> - Setting up filter UI</li>
<li><code>LoadSequence</code> - Loading image directory (if initial path provided)</li>
<li><strong>TOTAL MAINWINDOW CONSTRUCTOR TIME</strong> - Overall MainWindow creation time</li>
</ul>
<h3 id="3-loadsequence">3. LoadSequence</h3>
<ul>
<li><code>ResolveDirectory</code> - Determining target directory</li>
<li><code>EnsureDirectoryGuard</code> - Instance locking</li>
<li><code>Parse sort options and resolve focus</code> - Sort configuration</li>
<li><code>_sequence.LoadFromPath</code> - Enumerating files</li>
<li><code>Create ImageCache</code> - Initializing cache system</li>
<li><code>UpdateWindowTitle</code> - Setting window title</li>
<li><code>UpdateContextMenu</code> - Updating menu state</li>
<li><code>DisplayCurrentAsync</code> - Starting image display (fire and forget)</li>
<li><strong>TOTAL LOADSEQUENCE TIME</strong> - Overall sequence loading time</li>
</ul>
<h3 id="4-imagesequenceloadfrompath">4. ImageSequence.LoadFromPath</h3>
<ul>
<li><code>Get directory info</code> - Directory metadata</li>
<li><code>EnumerateFiles and filter</code> - Finding image files</li>
<li><code>Apply sort ordering</code> - Sorting files</li>
<li><code>Materialize file list</code> - Converting LINQ to list</li>
<li><code>Copy to _allImages</code> - Backup for filtering</li>
<li><code>Find initial index</code> - Locating starting image</li>
<li><strong>TOTAL LOADFROMPATH TIME</strong> - Overall enumeration time</li>
</ul>
<h3 id="5-displaycurrentasync">5. DisplayCurrentAsync</h3>
<p>This measures two different paths:</p>
<h4 id="cached-path-instant">Cached Path (instant):</h4>
<ul>
<li><code>TryGetCached (HIT)</code> - Found in cache</li>
<li><code>Set ImageDisplay.Source (cached)</code> - Setting UI</li>
<li><code>UpdateFitScale</code> - Calculating zoom</li>
<li><code>UpdateOverlay</code> - Updating overlay info</li>
<li><code>UpdateContextMenu</code> - Refreshing menu</li>
<li><code>UpdateWindowTitle</code> - Updating title</li>
<li><code>PreloadAround</code> - Starting preload (fire and forget)</li>
<li><strong>TOTAL DISPLAYCURRENT TIME (CACHED)</strong> - Cached display time</li>
</ul>
<h4 id="load-path-file-io">Load Path (file I/O):</h4>
<ul>
<li><code>TryGetCached (MISS)</code> - Not in cache</li>
<li><code>ShowMessage</code> - Showing "Loading..."</li>
<li><code>_cache.GetOrLoadAsync (actual load)</code> - Loading from disk</li>
<li><code>Set ImageDisplay.Source (loaded)</code> - Setting UI</li>
<li><code>UpdateFitScale</code> - Calculating zoom</li>
<li><code>UpdateOverlay</code> - Updating overlay info</li>
<li><code>UpdateContextMenu</code> - Refreshing menu</li>
<li><code>UpdateWindowTitle</code> - Updating title</li>
<li><code>PreloadAround</code> - Starting preload (fire and forget)</li>
<li><strong>TOTAL DISPLAYCURRENT TIME (LOADED)</strong> - Load display time</li>
</ul>
<h3 id="6-imagecacheloadbitmap-disk-io">6. ImageCache.LoadBitmap (disk I/O)</h3>
<ul>
<li><code>Get path from sequence</code> - Path lookup</li>
<li><code>Open FileStream</code> - Opening file handle</li>
<li><code>BitmapDecoder.Create</code> - Creating decoder</li>
<li><code>Get decoder.Frames[0]</code> - Accessing first frame</li>
<li><code>frame.Freeze()</code> - Making thread-safe</li>
<li><strong>TOTAL LOADBITMAP TIME</strong> - Overall file load time</li>
</ul>
<h2 id="viewing-the-results">Viewing the Results</h2>
<p>After running CoilViewer, open <code>coilviewer-launch.log</code> and look for the timing entries. Example output:</p>
<pre><code>[STARTUP] base.OnStartup: 2ms
[STARTUP] Logger.LogLaunch: 1ms
[STARTUP] Config loading: 3ms
[STARTUP] InitializeModelsAsync (fire and forget): 0ms
[STARTUP] Path resolution: 5ms
[STARTUP] DirectoryInstanceGuard setup: 1ms
[MAINWINDOW] InitializeComponent: 45ms
[MAINWINDOW] Field initialization: 0ms
[MAINWINDOW] ApplyConfig: 1ms
[MAINWINDOW] UpdateContextMenu: 0ms
[MAINWINDOW] InitializeFilterControls: 0ms
[IMAGESEQUENCE] Get directory info: 0ms
[IMAGESEQUENCE] EnumerateFiles and filter: 2ms
[IMAGESEQUENCE] Apply sort ordering: 0ms
[IMAGESEQUENCE] Materialize file list (150 files): 8ms
[IMAGESEQUENCE] Copy to _allImages: 0ms
[IMAGESEQUENCE] Find initial index: 0ms
[IMAGESEQUENCE] ========== TOTAL LOADFROMPATH TIME: 10ms ==========
[LOADSEQUENCE] _sequence.LoadFromPath: 10ms
[LOADSEQUENCE] Create ImageCache: 0ms
[DISPLAYCURRENT] TryGetCached (MISS): 0ms
[IMAGECACHE] Get path from sequence: 0ms
[IMAGECACHE] Open FileStream for &#39;image001.jpg&#39;: 1ms
[IMAGECACHE] BitmapDecoder.Create: 8ms
[IMAGECACHE] Get decoder.Frames[0]: 0ms
[IMAGECACHE] frame.Freeze(): 0ms
[IMAGECACHE] ========== TOTAL LOADBITMAP TIME for &#39;image001.jpg&#39;: 9ms ==========
[DISPLAYCURRENT] _cache.GetOrLoadAsync (actual load): 10ms
[DISPLAYCURRENT] Set ImageDisplay.Source (loaded): 1ms
[DISPLAYCURRENT] UpdateFitScale: 0ms
[DISPLAYCURRENT] UpdateOverlay: 1ms
[DISPLAYCURRENT] ========== TOTAL DISPLAYCURRENT TIME (LOADED): 15ms ==========
[MAINWINDOW] LoadSequence: 25ms
[MAINWINDOW] ========== TOTAL MAINWINDOW CONSTRUCTOR TIME: 71ms ==========
[STARTUP] MainWindow constructor: 71ms
[STARTUP] window.Show(): 5ms
[STARTUP] Window activation and focus: 1ms
[STARTUP] ========== TOTAL APP STARTUP TIME: 89ms ==========</code></pre>
<h2 id="understanding-the-results">Understanding the Results</h2>
<p>The timing breakdown helps you understand:</p>
<ol type="1">
<li><strong>Startup overhead</strong> - How long WPF initialization takes</li>
<li><strong>File enumeration</strong> - Time spent listing and sorting files</li>
<li><strong>Image loading</strong> - Actual disk I/O and decoding time</li>
<li><strong>UI updates</strong> - Time spent updating the interface</li>
<li><strong>Bottlenecks</strong> - Which operations take the most time</li>
</ol>
<h3 id="common-bottlenecks">Common Bottlenecks</h3>
<ul>
<li><strong>InitializeComponent</strong> (30-60ms) - XAML parsing, largest fixed cost</li>
<li><strong>Materialize file list</strong> - Scales with number of files in directory</li>
<li><strong>BitmapDecoder.Create</strong> - Varies by image size/format</li>
<li><strong>UpdateFitScale</strong> - Can be slow for very large images</li>
</ul>
<h3 id="what-was-fixed">What Was Fixed</h3>
<p>Previously, ML model initialization was <strong>blocking</strong> the startup (1000-3000ms). This is now asynchronous and shows as <code>0ms</code> in the log because it doesn't block the UI thread anymore.</p>
<h2 id="interpreting-fire-and-forget">Interpreting "fire and forget"</h2>
<p>When you see <code>(fire and forget): 0ms</code>, this means the operation was started asynchronously and doesn't block - the 0ms only measures the time to <strong>start</strong> the operation, not to complete it.</p>
<h2 id="next-steps">Next Steps</h2>
<p>If startup is still slow, examine the log to find the slowest operations:</p>
<ul>
<li>Look for operations taking &gt; 50ms</li>
<li>Check if file enumeration is slow (many files?)</li>
<li>Verify image decoding time (large images?)</li>
<li>Consider SSD vs HDD (file I/O)</li>
</ul>
<footer class="docweave-footer">
<div class="backlinks">
<strong>Referenced by:</strong> 
<a href="index.html">CoilViewer</a>
</div>
<div class="docweave-credit">Generated by docweave</div>
</footer>
</body>
</html>
